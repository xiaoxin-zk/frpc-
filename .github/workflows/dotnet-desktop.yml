name: Build and Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Get Version
      id: get_version
      run: |
        $version = $env:GITHUB_REF -replace "refs/tags/v", ""
        echo "VERSION=$version" >> $env:GITHUB_ENV
        echo "version=$version" >> $env:GITHUB_OUTPUT
        
    - name: Restore and Build
      run: |
        dotnet restore
        dotnet build --configuration Release --no-restore
        
    - name: Publish Single File
      run: |
        dotnet publish `
          --configuration Release `
          --output ./publish-single `
          --runtime win-x64 `
          --self-contained true `
          -p:PublishSingleFile=true `
          -p:PublishReadyToRun=true `
          -p:IncludeNativeLibrariesForSelfExtract=true
          
    - name: Publish Framework Dependent
      run: |
        dotnet publish `
          --configuration Release `
          --output ./publish-framework-dependent `
          --runtime win-x64 `
          --self-contained false
          
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ env.VERSION }}
        body: |
          FRP客户端管理器 ${{ env.VERSION }}
          
          更新内容：
          - 自动构建发布
          - 包含单文件版本和框架依赖版本
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload Single File Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./publish-single/FRPClientManager.exe
        asset_name: FRPClientManager-${{ env.VERSION }}-win-x64.exe
        asset_content_type: application/octet-stream
        
    - name: Upload Framework Dependent Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./publish-framework-dependent/FRPClientManager.exe
        asset_name: FRPClientManager-${{ env.VERSION }}-win-x64-framework-dependent.exe
        asset_content_type: application/octet-stream
        
    - name: Upload Symbols
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./publish-single/FRPClientManager.pdb
        asset_name: FRPClientManager-${{ env.VERSION }}-symbols.pdb
        asset_content_type: application/octet-stream
